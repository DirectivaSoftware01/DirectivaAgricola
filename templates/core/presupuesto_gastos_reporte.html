{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Gastos - {{ presupuesto.centro_costo.descripcion }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            .print-break {
                page-break-before: always;
            }
            body {
                font-size: 12px;
            }
            .table {
                font-size: 11px;
            }
        }
        
        .header-print {
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .presupuesto-section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        
        .presupuesto-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .clasificacion-section {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
        }
        
        .clasificacion-header {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .total-section {
            background-color: #e8f5e8;
            border: 2px solid #4caf50;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .subtotal-row {
            background-color: #f0f8ff;
            font-weight: bold;
        }
        
        .total-row {
            background-color: #e8f5e8;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .filters-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            margin-bottom: 10px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .hidden-row {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header-print">
            <div class="row">
                <div class="col-6">
                    <h2><i class="bi bi-cash-coin"></i> Reporte de Gastos</h2>
                    <p class="mb-0"><strong>Presupuesto:</strong> {{ presupuesto.centro_costo.descripcion }}</p>
                    <p class="mb-0"><strong>Ciclo:</strong> {{ ciclo_actual }}</p>
                </div>
                <div class="col-6 text-end">
                    <p class="mb-0"><strong>Fecha de Reporte:</strong> {% now "d/m/Y H:i" %}</p>
                    <p class="mb-0"><strong>Total Gastado:</strong> ${{ total_gastado|floatformat:2 }}</p>
                </div>
            </div>
            
            <!-- Resumen General en el header -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="total-section">
                        <div class="row">
                            <div class="col-md-6">
                                <h4 class="mb-0">Resumen General</h4>
                            </div>
                            <div class="col-md-6 text-end">
                                <h4 class="mb-0 text-success">
                                    Total Gastado: $<span id="totalGastadoFiltrado">{{ total_gastado|floatformat:2 }}</span>
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Botones de Acción en el header -->
            <div class="row mt-3 no-print">
                <div class="col-12">
                    <div class="d-flex justify-content-end">
                        <button onclick="window.print()" class="btn btn-primary">
                            <i class="bi bi-printer"></i> Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros de Búsqueda -->
        <div class="filters-section no-print">
            <h5><i class="bi bi-funnel"></i> Filtros de Búsqueda</h5>
            <div class="row">
                <div class="col-md-3">
                    <div class="filter-group">
                        <label class="filter-label">Clasificación de Gasto:</label>
                        <select id="filtroClasificacion" class="form-select form-select-sm">
                            <option value="">Todas las clasificaciones</option>
                            {% for clasificacion_data in gastos_por_clasificacion %}
                                <option value="{{ clasificacion_data.clasificacion.codigo }}">{{ clasificacion_data.clasificacion.descripcion }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="filter-group">
                        <label class="filter-label">Proveedor:</label>
                        <select id="filtroProveedor" class="form-select form-select-sm">
                            <option value="">Todos los proveedores</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="filter-group">
                        <label class="filter-label">Factura:</label>
                        <input type="text" id="filtroFactura" class="form-control form-control-sm" placeholder="Buscar factura...">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <div class="filter-group">
                        <label class="filter-label">Fecha Desde:</label>
                        <input type="date" id="filtroFechaDesde" class="form-control form-control-sm">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="filter-group">
                        <label class="filter-label">Fecha Hasta:</label>
                        <input type="date" id="filtroFechaHasta" class="form-control form-control-sm">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button onclick="aplicarFiltros()" class="btn btn-primary btn-sm">
                                <i class="bi bi-search"></i> Aplicar Filtros
                            </button>
                            <button onclick="limpiarFiltros()" class="btn btn-outline-secondary btn-sm ms-2">
                                <i class="bi bi-x-circle"></i> Limpiar
                            </button>
                        </div>
                        <div>
                            <span id="resultadosContador" class="text-muted">Mostrando todos los gastos</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Información del Presupuesto -->
        <div class="presupuesto-section">
            <div class="presupuesto-header">
                <h4 class="mb-0">Información del Presupuesto</h4>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <strong>Centro de Costo:</strong><br>
                    {{ presupuesto.centro_costo.descripcion }}
                </div>
                <div class="col-md-3">
                    <strong>Ciclo:</strong><br>
                    {{ ciclo_actual }}
                </div>
                <div class="col-md-3">
                    <strong>Total Presupuestado:</strong><br>
                    ${{ presupuesto.total_presupuestado|floatformat:2 }}
                </div>
                <div class="col-md-3">
                    <strong>Total Gastado:</strong><br>
                    <span class="text-success">${{ total_gastado|floatformat:2 }}</span>
                </div>
            </div>
        </div>

        <!-- Gastos por Clasificación -->
        {% if gastos_por_clasificacion %}
            {% for clasificacion_data in gastos_por_clasificacion %}
                <div class="clasificacion-section" data-clasificacion="{{ clasificacion_data.clasificacion.codigo }}">
                    <div class="clasificacion-header">
                        <i class="bi bi-tag"></i> {{ clasificacion_data.clasificacion.descripcion }}
                        <span class="float-end">Subtotal: ${{ clasificacion_data.subtotal|floatformat:2 }}</span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th class="text-center">Fecha</th>
                                    <th>Proveedor</th>
                                    <th>Factura</th>
                                    <th>Concepto</th>
                                    <th class="text-right">Importe</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detalle in clasificacion_data.detalles %}
                                    <tr class="gasto-row" 
                                        data-clasificacion="{{ clasificacion_data.clasificacion.codigo }}"
                                        data-proveedor="{{ detalle.proveedor.nombre|lower }}"
                                        data-factura="{{ detalle.factura|lower }}"
                                        data-concepto="{{ detalle.concepto|lower }}"
                                        data-fecha="{{ detalle.fecha_gasto|date:'Y-m-d' }}"
                                        data-importe="{{ detalle.importe }}">
                                        <td class="text-center">{{ detalle.fecha_gasto|date:"d/m/Y" }}</td>
                                        <td>{{ detalle.proveedor.nombre }}</td>
                                        <td>{{ detalle.factura }}</td>
                                        <td>{{ detalle.concepto }}</td>
                                        <td class="text-right">${{ detalle.importe|floatformat:2 }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="subtotal-row">
                                    <td colspan="4" class="text-right"><strong>{{ clasificacion_data.clasificacion.descripcion }}:</strong></td>
                                    <td class="text-right"><strong>${{ clasificacion_data.subtotal|floatformat:2 }}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> No hay gastos registrados para este presupuesto.
            </div>
        {% endif %}

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variables globales para el filtrado
        let gastosOriginales = [];
        let gastosFiltrados = [];
        
        // Inicializar datos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Guardar todos los gastos originales
            const filasGastos = document.querySelectorAll('.gasto-row');
            gastosOriginales = Array.from(filasGastos).map(fila => ({
                elemento: fila,
                clasificacion: fila.dataset.clasificacion,
                proveedor: fila.dataset.proveedor,
                factura: fila.dataset.factura,
                concepto: fila.dataset.concepto,
                fecha: fila.dataset.fecha,
                importe: parseFloat(fila.dataset.importe)
            }));
            
            // Poblar dropdown de proveedores
            poblarProveedores();
            
            gastosFiltrados = [...gastosOriginales];
            actualizarContador();
            actualizarTotalGastado();
        });
        
        // Función para poblar el dropdown de proveedores
        function poblarProveedores() {
            const selectProveedor = document.getElementById('filtroProveedor');
            
            // Obtener proveedores únicos
            const proveedoresUnicos = [...new Set(gastosOriginales.map(gasto => gasto.proveedor))].sort();
            
            // Limpiar opciones existentes (excepto la primera)
            selectProveedor.innerHTML = '<option value="">Todos los proveedores</option>';
            
            // Agregar opciones de proveedores
            proveedoresUnicos.forEach(proveedor => {
                const option = document.createElement('option');
                option.value = proveedor;
                option.textContent = proveedor;
                selectProveedor.appendChild(option);
            });
        }
        
        // Función para aplicar filtros
        function aplicarFiltros() {
            const filtroClasificacion = document.getElementById('filtroClasificacion').value;
            const filtroProveedor = document.getElementById('filtroProveedor').value;
            const filtroFactura = document.getElementById('filtroFactura').value.toLowerCase();
            const filtroFechaDesde = document.getElementById('filtroFechaDesde').value;
            const filtroFechaHasta = document.getElementById('filtroFechaHasta').value;
            
            // Filtrar gastos
            gastosFiltrados = gastosOriginales.filter(gasto => {
                // Filtro por clasificación
                if (filtroClasificacion && gasto.clasificacion !== filtroClasificacion) {
                    return false;
                }
                
                // Filtro por proveedor
                if (filtroProveedor && gasto.proveedor !== filtroProveedor) {
                    return false;
                }
                
                // Filtro por factura
                if (filtroFactura && !gasto.factura.includes(filtroFactura)) {
                    return false;
                }
                
                // Filtro por fecha desde
                if (filtroFechaDesde && gasto.fecha < filtroFechaDesde) {
                    return false;
                }
                
                // Filtro por fecha hasta
                if (filtroFechaHasta && gasto.fecha > filtroFechaHasta) {
                    return false;
                }
                
                return true;
            });
            
            // Mostrar/ocultar filas según filtros
            mostrarGastosFiltrados();
            actualizarContador();
            actualizarTotalGastado();
        }
        
        // Función para mostrar gastos filtrados
        function mostrarGastosFiltrados() {
            // Ocultar todas las filas de gastos
            gastosOriginales.forEach(gasto => {
                gasto.elemento.style.display = 'none';
            });
            
            // Mostrar solo las filas filtradas
            gastosFiltrados.forEach(gasto => {
                gasto.elemento.style.display = '';
            });
            
            // Ocultar secciones de clasificación que no tienen gastos visibles
            const seccionesClasificacion = document.querySelectorAll('.clasificacion-section');
            seccionesClasificacion.forEach(seccion => {
                const codigoClasificacion = seccion.dataset.clasificacion;
                const tieneGastosVisibles = gastosFiltrados.some(gasto => gasto.clasificacion === codigoClasificacion);
                
                if (tieneGastosVisibles) {
                    seccion.style.display = '';
                } else {
                    seccion.style.display = 'none';
                }
            });
        }
        
        // Función para limpiar filtros
        function limpiarFiltros() {
            document.getElementById('filtroClasificacion').value = '';
            document.getElementById('filtroProveedor').value = '';
            document.getElementById('filtroFactura').value = '';
            document.getElementById('filtroFechaDesde').value = '';
            document.getElementById('filtroFechaHasta').value = '';
            
            // Mostrar todos los gastos
            gastosFiltrados = [...gastosOriginales];
            mostrarGastosFiltrados();
            actualizarContador();
            actualizarTotalGastado();
        }
        
        // Función para actualizar contador de resultados
        function actualizarContador() {
            const contador = document.getElementById('resultadosContador');
            const totalGastos = gastosOriginales.length;
            const gastosVisibles = gastosFiltrados.length;
            
            if (gastosVisibles === totalGastos) {
                contador.textContent = `Mostrando todos los gastos (${totalGastos})`;
            } else {
                contador.textContent = `Mostrando ${gastosVisibles} de ${totalGastos} gastos`;
            }
        }
        
        // Función para actualizar el total gastado filtrado
        function actualizarTotalGastado() {
            const totalGastadoElement = document.getElementById('totalGastadoFiltrado');
            const totalGastadoFiltrado = gastosFiltrados.reduce((suma, gasto) => suma + gasto.importe, 0);
            totalGastadoElement.textContent = totalGastadoFiltrado.toFixed(2);
        }
        
        // Aplicar filtros automáticamente al cambiar los campos
        document.getElementById('filtroProveedor').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroFactura').addEventListener('input', aplicarFiltros);
        document.getElementById('filtroFechaDesde').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroFechaHasta').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroClasificacion').addEventListener('change', aplicarFiltros);
    </script>
</body>
</html>
