{% load humanize %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Gastos - {{ presupuesto.centro_costo.descripcion }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            .print-break {
                page-break-before: always;
            }
            body {
                font-size: 12px;
            }
            .table {
                font-size: 11px;
            }
        }
        
        .header-print {
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .presupuesto-section {
            margin-bottom: 30px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
        }
        
        .presupuesto-header {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .clasificacion-section {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 10px;
        }
        
        .clasificacion-header {
            background-color: #e3f2fd;
            padding: 8px;
            border-radius: 3px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .total-section {
            background-color: #e8f5e8;
            border: 2px solid #4caf50;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .table th {
            background-color: #f5f5f5;
            font-weight: bold;
        }
        
        .text-right {
            text-align: right;
        }
        
        .text-center {
            text-align: center;
        }
        
        .subtotal-row {
            background-color: #f0f8ff;
            font-weight: bold;
        }
        
        .total-row {
            background-color: #e8f5e8;
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .filters-section {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .filter-row {
            margin-bottom: 10px;
        }
        
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-label {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .hidden-row {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="header-print">
            <div class="row">
                <div class="col-6">
                    <h2><i class="bi bi-cash-coin"></i> Reporte de Gastos</h2>
                    <p class="mb-0"><strong>Presupuesto:</strong> {{ presupuesto.centro_costo.descripcion }}</p>
                    <p class="mb-0"><strong>Ciclo:</strong> {{ ciclo_actual }}</p>
                </div>
                <div class="col-6 text-end">
                    <p class="mb-0"><strong>Fecha de Reporte:</strong> {% now "d/m/Y H:i" %}</p>
                    <p class="mb-0"><strong>Total Gastado:</strong> ${{ total_gastado|floatformat:2 }}</p>
                </div>
            </div>
            
            <!-- Resumen General en el header -->
            <div class="row mt-3">
                <div class="col-12">
                    <div class="total-section">
                        <div class="row">
                            <div class="col-md-6">
                                <h4 class="mb-0">Resumen General</h4>
                            </div>
                            <div class="col-md-6 text-end">
                                <h4 class="mb-0 text-success">
                                    Total Gastado: $<span id="totalGastadoFiltrado">{{ total_gastado|floatformat:2 }}</span>
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Botones de Acción en el header -->
            <div class="row mt-3 no-print">
                <div class="col-12">
                    <div class="d-flex justify-content-end">
                        <button onclick="window.print()" class="btn btn-primary">
                            <i class="bi bi-printer"></i> Imprimir
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros de Búsqueda -->
        <div class="filters-section no-print">
            <h5><i class="bi bi-funnel"></i> Filtros de Búsqueda</h5>
            <form method="get" id="formFiltros">
                {% csrf_token %}
                <div class="row">
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label class="filter-label">Ciclo:</label>
                            <select name="ciclo" id="filtroCiclo" class="form-select form-select-sm">
                                <option value="">Todos los ciclos</option>
                                {% for ciclo_item in ciclos_disponibles %}
                                    <option value="{{ ciclo_item }}" {% if ciclo_item == ciclo %}selected{% endif %}>{{ ciclo_item }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label class="filter-label">Centro de Costo:</label>
                            <select name="centro_costo" id="filtroCentroCosto" class="form-select form-select-sm">
                                <option value="">Todos los centros de costo</option>
                                {% for centro in centros_costo %}
                                    <option value="{{ centro.codigo }}" {% if centro.codigo|stringformat:"s" == centro_costo_id %}selected{% endif %}>{{ centro.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label class="filter-label">Clasificación de Gasto:</label>
                            <select id="filtroClasificacion" class="form-select form-select-sm">
                                <option value="">Todas las clasificaciones</option>
                                {% for clasificacion_data in gastos_por_clasificacion %}
                                    <option value="{{ clasificacion_data.clasificacion.codigo }}">{{ clasificacion_data.clasificacion.descripcion }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label class="filter-label">Proveedor:</label>
                            <select id="filtroProveedor" class="form-select form-select-sm">
                                <option value="">Todos los proveedores</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label class="filter-label">Forma de Pago:</label>
                            <select id="filtroFormaPago" name="forma_pago" class="form-select form-select-sm">
                                <option value="">Todas las formas de pago</option>
                                <option value="01" {% if forma_pago == '01' %}selected{% endif %}>01 - Efectivo</option>
                                <option value="02" {% if forma_pago == '02' %}selected{% endif %}>02 - Cheque nominativo</option>
                                <option value="03" {% if forma_pago == '03' %}selected{% endif %}>03 - Transferencia electrónica de fondos</option>
                                <option value="04" {% if forma_pago == '04' %}selected{% endif %}>04 - Tarjeta de crédito</option>
                                <option value="05" {% if forma_pago == '05' %}selected{% endif %}>05 - Monedero electrónico</option>
                                <option value="06" {% if forma_pago == '06' %}selected{% endif %}>06 - Dinero electrónico</option>
                                <option value="08" {% if forma_pago == '08' %}selected{% endif %}>08 - Vales de despensa</option>
                                <option value="12" {% if forma_pago == '12' %}selected{% endif %}>12 - Dación en pago</option>
                                <option value="13" {% if forma_pago == '13' %}selected{% endif %}>13 - Pago por subrogación</option>
                                <option value="14" {% if forma_pago == '14' %}selected{% endif %}>14 - Pago por consignación</option>
                                <option value="15" {% if forma_pago == '15' %}selected{% endif %}>15 - Condonación</option>
                                <option value="17" {% if forma_pago == '17' %}selected{% endif %}>17 - Compensación</option>
                                <option value="23" {% if forma_pago == '23' %}selected{% endif %}>23 - Novación</option>
                                <option value="24" {% if forma_pago == '24' %}selected{% endif %}>24 - Confusión</option>
                                <option value="25" {% if forma_pago == '25' %}selected{% endif %}>25 - Remisión de deuda</option>
                                <option value="26" {% if forma_pago == '26' %}selected{% endif %}>26 - Prescripción o caducidad</option>
                                <option value="27" {% if forma_pago == '27' %}selected{% endif %}>27 - A satisfacción del acreedor</option>
                                <option value="28" {% if forma_pago == '28' %}selected{% endif %}>28 - Tarjeta de débito</option>
                                <option value="29" {% if forma_pago == '29' %}selected{% endif %}>29 - Tarjeta de servicios</option>
                                <option value="30" {% if forma_pago == '30' %}selected{% endif %}>30 - Aplicación de anticipos</option>
                                <option value="31" {% if forma_pago == '31' %}selected{% endif %}>31 - Intermediario pagos</option>
                                <option value="99" {% if forma_pago == '99' %}selected{% endif %}>99 - Por definir</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label class="filter-label">Autorizó:</label>
                            <select id="filtroAutorizo" name="autorizo" class="form-select form-select-sm">
                                <option value="">Todas las personas</option>
                                {% for persona in personas_autorizan %}
                                    <option value="{{ persona.id }}" {% if persona.id|stringformat:"s" == autorizo_id %}selected{% endif %}>{{ persona.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label class="filter-label">Factura:</label>
                            <input type="text" id="filtroFactura" class="form-control form-control-sm" placeholder="Buscar factura...">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label class="filter-label">Fecha Desde:</label>
                            <input type="date" id="filtroFechaDesde" class="form-control form-control-sm">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="filter-group">
                            <label class="filter-label">Fecha Hasta:</label>
                            <input type="date" id="filtroFechaHasta" class="form-control form-control-sm">
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="bi bi-search"></i> Aplicar Filtros
                                </button>
                                <button type="button" onclick="limpiarFiltros()" class="btn btn-outline-secondary btn-sm ms-2">
                                    <i class="bi bi-x-circle"></i> Limpiar
                                </button>
                            </div>
                            <div>
                                <span id="resultadosContador" class="text-muted">Mostrando todos los gastos</span>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Información del Presupuesto -->
        <div class="presupuesto-section">
            <div class="presupuesto-header">
                <h4 class="mb-0">Información del Presupuesto</h4>
            </div>
            <div class="row">
                <div class="col-md-3">
                    <strong>Centro de Costo:</strong><br>
                    {{ presupuesto.centro_costo.descripcion }}
                </div>
                <div class="col-md-3">
                    <strong>Ciclo:</strong><br>
                    {{ ciclo_actual }}
                </div>
                <div class="col-md-3">
                    <strong>Total Presupuestado:</strong><br>
                    ${{ presupuesto.total_presupuestado|floatformat:2 }}
                </div>
                <div class="col-md-3">
                    <strong>Total Gastado:</strong><br>
                    <span class="text-success">${{ total_gastado|floatformat:2 }}</span>
                </div>
            </div>
        </div>

        <!-- Gastos por Clasificación -->
        {% if gastos_por_clasificacion %}
            {% for clasificacion_data in gastos_por_clasificacion %}
                <div class="clasificacion-section" data-clasificacion="{{ clasificacion_data.clasificacion.codigo }}">
                    <div class="clasificacion-header">
                        <i class="bi bi-tag"></i> {{ clasificacion_data.clasificacion.descripcion }}
                        <span class="float-end">Subtotal: ${{ clasificacion_data.subtotal|floatformat:2 }}</span>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th class="text-center">Fecha</th>
                                    <th>Centro de Costo</th>
                                    <th>Proveedor</th>
                                    <th>Factura</th>
                                    <th>Concepto</th>
                                    <th>Forma de Pago</th>
                                    <th>Autorizó</th>
                                    <th class="text-right">Importe</th>
                                    <th class="text-center no-print">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for detalle in clasificacion_data.detalles %}
                                    <tr class="gasto-row" 
                                        data-clasificacion="{{ clasificacion_data.clasificacion.codigo }}"
                                        data-proveedor="{{ detalle.proveedor.nombre|lower }}"
                                        data-factura="{{ detalle.factura|lower }}"
                                        data-concepto="{{ detalle.concepto|lower }}"
                                        data-fecha="{{ detalle.fecha_gasto|date:'Y-m-d' }}"
                                        data-importe="{{ detalle.importe }}"
                                        data-centro-costo="{{ detalle.centro_costo.descripcion|lower }}">
                                        <td class="text-center">{{ detalle.fecha_gasto|date:"d/m/Y" }}</td>
                                        <td>{{ detalle.centro_costo.descripcion }}</td>
                                        <td>{{ detalle.proveedor.nombre }}</td>
                                        <td>{{ detalle.factura }}</td>
                                        <td>{{ detalle.concepto }}</td>
                                        <td>
                                            {% if detalle.forma_pago %}
                                                {% if detalle.forma_pago == '01' %}
                                                    <span class="badge bg-secondary">01 - Efectivo</span>
                                                {% elif detalle.forma_pago == '02' %}
                                                    <span class="badge bg-secondary">02 - Cheque nominativo</span>
                                                {% elif detalle.forma_pago == '03' %}
                                                    <span class="badge bg-secondary">03 - Transferencia electrónica de fondos</span>
                                                {% elif detalle.forma_pago == '04' %}
                                                    <span class="badge bg-secondary">04 - Tarjeta de crédito</span>
                                                {% elif detalle.forma_pago == '05' %}
                                                    <span class="badge bg-secondary">05 - Monedero electrónico</span>
                                                {% elif detalle.forma_pago == '06' %}
                                                    <span class="badge bg-secondary">06 - Dinero electrónico</span>
                                                {% elif detalle.forma_pago == '08' %}
                                                    <span class="badge bg-secondary">08 - Vales de despensa</span>
                                                {% elif detalle.forma_pago == '12' %}
                                                    <span class="badge bg-secondary">12 - Dación en pago</span>
                                                {% elif detalle.forma_pago == '13' %}
                                                    <span class="badge bg-secondary">13 - Pago por subrogación</span>
                                                {% elif detalle.forma_pago == '14' %}
                                                    <span class="badge bg-secondary">14 - Pago por consignación</span>
                                                {% elif detalle.forma_pago == '15' %}
                                                    <span class="badge bg-secondary">15 - Condonación</span>
                                                {% elif detalle.forma_pago == '17' %}
                                                    <span class="badge bg-secondary">17 - Compensación</span>
                                                {% elif detalle.forma_pago == '23' %}
                                                    <span class="badge bg-secondary">23 - Novación</span>
                                                {% elif detalle.forma_pago == '24' %}
                                                    <span class="badge bg-secondary">24 - Confusión</span>
                                                {% elif detalle.forma_pago == '25' %}
                                                    <span class="badge bg-secondary">25 - Remisión de deuda</span>
                                                {% elif detalle.forma_pago == '26' %}
                                                    <span class="badge bg-secondary">26 - Prescripción o caducidad</span>
                                                {% elif detalle.forma_pago == '27' %}
                                                    <span class="badge bg-secondary">27 - A satisfacción del acreedor</span>
                                                {% elif detalle.forma_pago == '28' %}
                                                    <span class="badge bg-secondary">28 - Tarjeta de débito</span>
                                                {% elif detalle.forma_pago == '29' %}
                                                    <span class="badge bg-secondary">29 - Tarjeta de servicios</span>
                                                {% elif detalle.forma_pago == '30' %}
                                                    <span class="badge bg-secondary">30 - Aplicación de anticipos</span>
                                                {% elif detalle.forma_pago == '31' %}
                                                    <span class="badge bg-secondary">31 - Intermediario pagos</span>
                                                {% elif detalle.forma_pago == '99' %}
                                                    <span class="badge bg-secondary">99 - Por definir</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">{{ detalle.forma_pago }}</span>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if detalle.autorizo %}
                                                <span class="badge bg-info">{{ detalle.autorizo.nombre }}</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-right">${{ detalle.importe|floatformat:2 }}</td>
                                        <td class="text-center">
                                            {% if detalle.gasto.activo %}
                                                <button type="button" 
                                                        class="btn btn-sm btn-outline-danger cancelar-gasto-btn no-print" 
                                                        data-gasto-id="{{ detalle.gasto.codigo }}"
                                                        data-gasto-factura="{{ detalle.factura }}"
                                                        data-gasto-proveedor="{{ detalle.proveedor.nombre }}"
                                                        title="Cancelar gasto">
                                                    <i class="bi bi-x-circle"></i>
                                                </button>
                                            {% else %}
                                                <span class="badge bg-secondary">Cancelado</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot>
                                <tr class="subtotal-row">
                                    <td colspan="8" class="text-right"><strong>{{ clasificacion_data.clasificacion.descripcion }}:</strong></td>
                                    <td class="text-right"><strong>${{ clasificacion_data.subtotal|floatformat:2 }}</strong></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> No hay gastos registrados para este presupuesto.
            </div>
        {% endif %}

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        // Variables globales para el filtrado
        let gastosOriginales = [];
        let gastosFiltrados = [];
        
        // Inicializar datos al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // Guardar todos los gastos originales
            const filasGastos = document.querySelectorAll('.gasto-row');
            gastosOriginales = Array.from(filasGastos).map(fila => ({
                elemento: fila,
                clasificacion: fila.dataset.clasificacion,
                proveedor: fila.dataset.proveedor,
                factura: fila.dataset.factura,
                concepto: fila.dataset.concepto,
                fecha: fila.dataset.fecha,
                importe: parseFloat(fila.dataset.importe),
                centroCosto: fila.dataset.centroCosto
            }));
            
            // Poblar dropdown de proveedores
            poblarProveedores();
            
            gastosFiltrados = [...gastosOriginales];
            actualizarContador();
            actualizarTotalGastado();
        });
        
        // Función para poblar el dropdown de proveedores
        function poblarProveedores() {
            const selectProveedor = document.getElementById('filtroProveedor');
            
            // Obtener proveedores únicos
            const proveedoresUnicos = [...new Set(gastosOriginales.map(gasto => gasto.proveedor))].sort();
            
            // Limpiar opciones existentes (excepto la primera)
            selectProveedor.innerHTML = '<option value="">Todos los proveedores</option>';
            
            // Agregar opciones de proveedores
            proveedoresUnicos.forEach(proveedor => {
                const option = document.createElement('option');
                option.value = proveedor;
                option.textContent = proveedor;
                selectProveedor.appendChild(option);
            });
        }
        
        // Función para aplicar filtros
        function aplicarFiltros() {
            const filtroCiclo = document.getElementById('filtroCiclo').value;
            const filtroCentroCosto = document.getElementById('filtroCentroCosto').value;
            const filtroClasificacion = document.getElementById('filtroClasificacion').value;
            const filtroProveedor = document.getElementById('filtroProveedor').value;
            const filtroFactura = document.getElementById('filtroFactura').value.toLowerCase();
            const filtroFechaDesde = document.getElementById('filtroFechaDesde').value;
            const filtroFechaHasta = document.getElementById('filtroFechaHasta').value;
            
            // Si hay filtros de servidor (Ciclo o Centro de Costo), enviar formulario
            if (filtroCiclo || filtroCentroCosto) {
                document.getElementById('formFiltros').submit();
                return;
            }
            
            // Filtrar gastos en el cliente
            gastosFiltrados = gastosOriginales.filter(gasto => {
                // Filtro por clasificación
                if (filtroClasificacion && gasto.clasificacion !== filtroClasificacion) {
                    return false;
                }
                
                // Filtro por proveedor
                if (filtroProveedor && gasto.proveedor !== filtroProveedor) {
                    return false;
                }
                
                // Filtro por factura
                if (filtroFactura && !gasto.factura.includes(filtroFactura)) {
                    return false;
                }
                
                // Filtro por fecha desde
                if (filtroFechaDesde && gasto.fecha < filtroFechaDesde) {
                    return false;
                }
                
                // Filtro por fecha hasta
                if (filtroFechaHasta && gasto.fecha > filtroFechaHasta) {
                    return false;
                }
                
                return true;
            });
            
            // Mostrar/ocultar filas según filtros
            mostrarGastosFiltrados();
            actualizarContador();
            actualizarTotalGastado();
        }
        
        // Función para mostrar gastos filtrados
        function mostrarGastosFiltrados() {
            // Ocultar todas las filas de gastos
            gastosOriginales.forEach(gasto => {
                gasto.elemento.style.display = 'none';
            });
            
            // Mostrar solo las filas filtradas
            gastosFiltrados.forEach(gasto => {
                gasto.elemento.style.display = '';
            });
            
            // Ocultar secciones de clasificación que no tienen gastos visibles
            const seccionesClasificacion = document.querySelectorAll('.clasificacion-section');
            seccionesClasificacion.forEach(seccion => {
                const codigoClasificacion = seccion.dataset.clasificacion;
                const tieneGastosVisibles = gastosFiltrados.some(gasto => gasto.clasificacion === codigoClasificacion);
                
                if (tieneGastosVisibles) {
                    seccion.style.display = '';
                } else {
                    seccion.style.display = 'none';
                }
            });
        }
        
        // Función para limpiar filtros
        function limpiarFiltros() {
            document.getElementById('filtroCiclo').value = '';
            document.getElementById('filtroCentroCosto').value = '';
            document.getElementById('filtroClasificacion').value = '';
            document.getElementById('filtroProveedor').value = '';
            document.getElementById('filtroFactura').value = '';
            document.getElementById('filtroFechaDesde').value = '';
            document.getElementById('filtroFechaHasta').value = '';
            
            // Redirigir a la página sin filtros
            window.location.href = window.location.pathname;
        }
        
        // Función para actualizar contador de resultados
        function actualizarContador() {
            const contador = document.getElementById('resultadosContador');
            const totalGastos = gastosOriginales.length;
            const gastosVisibles = gastosFiltrados.length;
            
            if (gastosVisibles === totalGastos) {
                contador.textContent = `Mostrando todos los gastos (${totalGastos})`;
            } else {
                contador.textContent = `Mostrando ${gastosVisibles} de ${totalGastos} gastos`;
            }
        }
        
        // Función para actualizar el total gastado filtrado
        function actualizarTotalGastado() {
            const totalGastadoElement = document.getElementById('totalGastadoFiltrado');
            const totalGastadoFiltrado = gastosFiltrados.reduce((suma, gasto) => suma + gasto.importe, 0);
            totalGastadoElement.textContent = totalGastadoFiltrado.toFixed(2);
        }
        
        // Aplicar filtros automáticamente al cambiar los campos
        document.getElementById('filtroProveedor').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroFactura').addEventListener('input', aplicarFiltros);
        document.getElementById('filtroFechaDesde').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroFechaHasta').addEventListener('change', aplicarFiltros);
        document.getElementById('filtroClasificacion').addEventListener('change', aplicarFiltros);
        
        // Manejar cancelación de gastos
        let gastoACancelar = null;
        console.log('JavaScript de cancelación de gastos cargado');
        
        // Event listener para botones de cancelar gasto
        document.addEventListener('click', function(e) {
            if (e.target.closest('.cancelar-gasto-btn')) {
                console.log('Botón de cancelar gasto clickeado');
                e.preventDefault();
                const btn = e.target.closest('.cancelar-gasto-btn');
                gastoACancelar = {
                    id: btn.dataset.gastoId,
                    factura: btn.dataset.gastoFactura,
                    proveedor: btn.dataset.gastoProveedor,
                    importe: btn.closest('tr').querySelector('td:last-child').previousElementSibling.textContent
                };
                
                // Llenar modal con datos del gasto
                document.getElementById('modal-proveedor').textContent = gastoACancelar.proveedor;
                document.getElementById('modal-factura').textContent = gastoACancelar.factura;
                document.getElementById('modal-importe').textContent = gastoACancelar.importe;
                
                // Mostrar modal
                const modal = new bootstrap.Modal(document.getElementById('cancelarGastoModal'));
                modal.show();
            }
        });
        
        // Confirmar cancelación de gasto
        const confirmarBtn = document.getElementById('confirmarCancelarGasto');
        if (confirmarBtn) {
            confirmarBtn.addEventListener('click', function() {
                if (gastoACancelar) {
                    cancelarGasto(gastoACancelar.id);
                }
            });
        }
        
        // Función para cancelar gasto
        function cancelarGasto(gastoId) {
            console.log('Iniciando cancelación del gasto:', gastoId);
            fetch(`/ajax/gastos/${gastoId}/cancelar/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Cerrar modal
                    bootstrap.Modal.getInstance(document.getElementById('cancelarGastoModal')).hide();
                    
                    // Mostrar mensaje de éxito
                    alert('Gasto cancelado exitosamente.');
                    
                    // Recargar la página para actualizar los datos
                    window.location.reload();
                } else {
                    alert('Error al cancelar el gasto: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error al cancelar el gasto. Inténtalo de nuevo.');
            });
        }
        }); // Cerrar DOMContentLoaded
    </script>

    <!-- Modal de Confirmación para Cancelar Gasto -->
    <div class="modal fade" id="cancelarGastoModal" tabindex="-1" aria-labelledby="cancelarGastoModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cancelarGastoModalLabel">
                        <i class="bi bi-exclamation-triangle text-warning"></i> Confirmar Cancelación de Gasto
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que deseas cancelar este gasto?</p>
                    <div class="alert alert-warning">
                        <strong>Detalles del gasto:</strong><br>
                        <strong>Proveedor:</strong> <span id="modal-proveedor"></span><br>
                        <strong>Factura:</strong> <span id="modal-factura"></span><br>
                        <strong>Importe:</strong> <span id="modal-importe"></span>
                    </div>
                    <p class="text-muted">Esta acción marcará el gasto como inactivo y no se podrá deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmarCancelarGasto">
                        <i class="bi bi-x-circle"></i> Sí, Cancelar Gasto
                    </button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
