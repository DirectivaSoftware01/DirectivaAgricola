{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .cliente-header {
        background-color: #f8f9fa;
        border-left: 4px solid #007bff;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
    }
    
    .cliente-total {
        background-color: #e3f2fd;
        border: 1px solid #2196f3;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 15px;
    }
    
    .estado-badge {
        font-size: 0.8em;
        padding: 4px 8px;
    }
    
    .importe-cell {
        text-align: right;
        font-weight: bold;
    }
    
    .total-general {
        background-color: #d4edda;
        border: 2px solid #28a745;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="bi bi-cash-coin text-primary"></i>
            Cobranza - Remisiones Preliquidadas
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="{% url 'core:dashboard' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver al Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Filtros de búsqueda -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="card-title mb-0">
                <i class="bi bi-search"></i> Buscar estado de cuenta
            </h5>
        </div>
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-3">
                    {{ search_form.busqueda.label_tag }}
                    {{ search_form.busqueda }}
                </div>
                <div class="col-md-2">
                    {{ search_form.cliente.label_tag }}
                    {{ search_form.cliente }}
                </div>
                <div class="col-md-2">
                    {{ search_form.estado_facturacion.label_tag }}
                    {{ search_form.estado_facturacion }}
                </div>
                <div class="col-md-2">
                    {{ search_form.estado_pago.label_tag }}
                    {{ search_form.estado_pago }}
                </div>
                <div class="col-md-1">
                    {{ search_form.fecha_desde.label_tag }}
                    {{ search_form.fecha_desde }}
                </div>
                <div class="col-md-1">
                    {{ search_form.fecha_hasta.label_tag }}
                    {{ search_form.fecha_hasta }}
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-outline-primary me-2">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                    <a href="{% url 'core:cobranza_list' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-clockwise"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Resumen General -->
    {% if total_general > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="total-general">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-0 text-success">
                            <i class="bi bi-calculator"></i>
                            Total General de Cobranza
                        </h4>
                        <p class="mb-0 text-muted">Suma de todos los importes liquidados</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <h3 class="mb-0 text-success">
                            ${{ total_general|floatformat:2|intcomma }}
                        </h3>
                        <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="imprimirEstadoCuenta()">
                            <i class="bi bi-printer"></i> Estado de Cuenta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Lista de Clientes y Remisiones -->
    {% if remisiones_agrupadas %}
        {% for cliente, remisiones, total_cliente in remisiones_agrupadas %}
        <div class="row mb-4">
            <div class="col-12">
                <!-- Header del Cliente -->
                <div class="cliente-header">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-1">
                                <i class="bi bi-person-circle text-primary"></i>
                                {{ cliente.razon_social }}
                            </h5>
                            <p class="mb-0 text-muted">
                                <i class="bi bi-building"></i> {{ cliente.razon_social|default:"Sin razón social" }}
                                {% if cliente.rfc %}
                                    | <i class="bi bi-card-text"></i> RFC: {{ cliente.rfc }}
                                {% endif %}
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="cliente-total">
                                <h6 class="mb-0 text-primary">
                                    <i class="bi bi-calculator"></i>
                                    Total Cliente
                                </h6>
                                <h4 class="mb-0 text-primary">
                                    ${{ total_cliente|floatformat:2|intcomma }}
                                </h4>
                                <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="imprimirEstadoCuentaCliente('{{ cliente.razon_social }}', {{ cliente.codigo }})">
                                    <i class="bi bi-printer"></i> Estado de Cuenta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Remisiones del Cliente -->
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Ciclo - Folio</th>
                                <th>Fecha</th>
                                <th>Importe Liquidado</th>
                                <th>Estado Facturación</th>
                                <th>Estado Pago</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for remision, importe_remision in remisiones %}
                            <tr>
                                <td>
                                    <strong>{{ remision.ciclo }} - {{ remision.folio|stringformat:"06d" }}</strong>
                                </td>
                                <td>{{ remision.fecha|date:"d/m/Y" }}</td>
                                <td class="importe-cell">
                                    ${{ importe_remision|floatformat:2|intcomma }}
                                </td>
                                <td>
                                    {% if remision.facturado %}
                                        <span class="badge bg-success estado-badge">
                                            <i class="bi bi-check-circle"></i> Facturado
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning estado-badge">
                                            <i class="bi bi-clock"></i> Pendiente
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if remision.pagado %}
                                        <span class="badge bg-success estado-badge">
                                            <i class="bi bi-check-circle"></i> Pagado
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning estado-badge">
                                            <i class="bi bi-clock"></i> Pendiente
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'core:remision_detail' remision.pk %}" 
                                           class="btn btn-sm btn-outline-info" 
                                           title="Ver detalles">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        {% if not remision.facturado %}
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-primary" 
                                                title="Marcar como Facturado"
                                                onclick="marcarFacturado({{ remision.pk }})">
                                            <i class="bi bi-receipt"></i>
                                        </button>
                                        {% endif %}
                                        {% if remision.facturado and not remision.pagado %}
                                        <button type="button" 
                                                class="btn btn-sm btn-outline-success" 
                                                title="Marcar como Pagado"
                                                onclick="marcarPagado({{ remision.pk }})">
                                            <i class="bi bi-cash-coin"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <!-- Mensaje cuando no hay remisiones -->
        <div class="row">
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle fs-1"></i>
                    <h4 class="mt-3">No hay remisiones preliquidadas</h4>
                    <p class="mb-0">
                        No se encontraron remisiones con estado "Preliquidada" para mostrar en cobranza.
                        <br>
                        <a href="{% url 'core:cobranza_list' %}" class="btn btn-primary mt-2">
                            <i class="bi bi-arrow-clockwise"></i> Ir a Cobranza
                        </a>
                    </p>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Paginación -->
    {% if is_paginated %}
    <div class="row">
        <div class="col-12">
            <nav aria-label="Paginación de cobranza">
                <ul class="pagination justify-content-center">
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1">
                                <i class="bi bi-chevron-double-left"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    {% endif %}

                    <li class="page-item active">
                        <span class="page-link">
                            Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                        </span>
                    </li>

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">
                                <i class="bi bi-chevron-double-right"></i>
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de Confirmación -->
<div class="modal fade" id="modalConfirmacion" tabindex="-1" aria-labelledby="modalConfirmacionLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalConfirmacionLabel">
                    <i class="bi bi-question-circle"></i> Confirmar Acción
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="modalConfirmacionBody">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="btnConfirmarAccion">
                    <i class="bi bi-check-circle"></i> Confirmar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let remisionActualId = null;
let accionActual = null;

function marcarFacturado(remisionId) {
    remisionActualId = remisionId;
    accionActual = 'facturado';
    
    document.getElementById('modalConfirmacionLabel').innerHTML = 
        '<i class="bi bi-receipt"></i> Marcar como Facturado';
    document.getElementById('modalConfirmacionBody').innerHTML = 
        '<p>¿Está seguro de que desea marcar esta remisión como <strong>Facturada</strong>?</p>' +
        '<p class="text-muted">Esta acción actualizará el estado de facturación de la remisión.</p>';
    
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
    modal.show();
}

function marcarPagado(remisionId) {
    remisionActualId = remisionId;
    accionActual = 'pagado';
    
    document.getElementById('modalConfirmacionLabel').innerHTML = 
        '<i class="bi bi-cash-coin"></i> Marcar como Pagado';
    document.getElementById('modalConfirmacionBody').innerHTML = 
        '<p>¿Está seguro de que desea marcar esta remisión como <strong>Pagada</strong>?</p>' +
        '<p class="text-muted">Esta acción actualizará el estado de pago de la remisión.</p>';
    
    const modal = new bootstrap.Modal(document.getElementById('modalConfirmacion'));
    modal.show();
}

document.getElementById('btnConfirmarAccion').addEventListener('click', function() {
    if (!remisionActualId || !accionActual) {
        alert('Error: No se ha seleccionado una acción válida.');
        return;
    }
    
    const btnConfirmar = this;
    const btnOriginal = btnConfirmar.innerHTML;
    
    // Deshabilitar botón y mostrar loading
    btnConfirmar.disabled = true;
    btnConfirmar.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Procesando...';
    
    // Preparar datos
    const data = {
        'accion': accionActual,
        'csrfmiddlewaretoken': document.querySelector('[name=csrfmiddlewaretoken]').value
    };
    
    // Enviar petición AJAX
    fetch(`/ajax/remisiones/${remisionActualId}/cobranza/`, {
        method: 'POST',
        body: new URLSearchParams(data),
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Mostrar mensaje de éxito
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle"></i> ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.container-fluid').firstChild);
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalConfirmacion'));
            modal.hide();
            
            // Recargar la página para mostrar los cambios
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            alert('Error: ' + (data.error || 'Error desconocido'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error de conexión. Por favor, intente nuevamente.');
    })
    .finally(() => {
        // Restaurar botón
        btnConfirmar.disabled = false;
        btnConfirmar.innerHTML = btnOriginal;
    });
});

// Funciones para impresión de estado de cuenta
function imprimirEstadoCuenta() {
    // Obtener los parámetros de búsqueda actuales
    const urlParams = new URLSearchParams(window.location.search);
    const params = urlParams.toString();
    
    // Abrir ventana de impresión con los filtros actuales
    const url = `/cobranza/imprimir/?${params}`;
    window.open(url, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
}

function imprimirEstadoCuentaCliente(nombreCliente, codigoCliente) {
    // Obtener los parámetros de búsqueda actuales
    const urlParams = new URLSearchParams(window.location.search);
    
    // Agregar filtro específico del cliente
    urlParams.set('cliente', codigoCliente);
    
    const params = urlParams.toString();
    
    // Abrir ventana de impresión para el cliente específico
    const url = `/cobranza/imprimir/?${params}`;
    window.open(url, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');
}
</script>
{% endblock %}
