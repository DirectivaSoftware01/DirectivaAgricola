{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .factura-container {
        background: #f8f9fa;
        min-height: 100vh;
        padding: 20px 0;
    }
    
    .factura-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
    }
    
    .factura-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px 10px 0 0;
    }
    
    .section-title {
        color: #495057;
        font-weight: 600;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .form-section {
        padding: 20px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .form-section:last-child {
        border-bottom: none;
    }
    
    .detalle-row {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 10px;
    }
    
    .totales-section {
        background: #e9ecef;
        padding: 20px;
        border-radius: 0 0 10px 10px;
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .total-row:last-child {
        border-bottom: none;
        font-weight: bold;
        font-size: 1.2em;
        color: #495057;
    }
    
    .btn-action {
        margin: 5px;
    }
    
    .producto-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .detalle-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 10px;
    }
    
    .detalle-item .row {
        margin-bottom: 10px;
    }
    
    .detalle-item .row:last-child {
        margin-bottom: 0;
    }
    
    /* Ocultar datos del emisor para reducir tamaño visual */
    .datos-emisor-ocultos {
        visibility: hidden;
        height: 0;
        overflow: hidden;
        margin: 0;
        padding: 0;
    }
    
    .btn-remove-item {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
    }
    
    .detalle-item {
        position: relative;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: #dee2e6;
    }
    
    /* Estilos para el campo de error de timbrado */
    #errorTimbradoCard {
        animation: slideInUp 0.3s ease-out;
        box-shadow: 0 0.5rem 1rem rgba(220, 53, 69, 0.15);
        border-left: 4px solid #dc3545;
    }
    
    #errorTimbradoCard .card-header {
        background: linear-gradient(135deg, #dc3545, #c82333);
        border: none;
    }
    
    #errorTimbradoCard .alert {
        border: none;
        background-color: #f8d7da;
        color: #721c24;
    }
    
    #errorTimbradoDetalle {
        font-family: 'Courier New', monospace;
        background-color: rgba(0, 0, 0, 0.05);
        padding: 1rem;
        border-radius: 0.375rem;
        border-left: 3px solid #dc3545;
    }
    
    #errorTimbradoDetalle ul {
        margin-bottom: 0;
        padding-left: 1.5rem;
    }
    
    #errorTimbradoDetalle li {
        margin-bottom: 0.25rem;
    }
    
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Botón de cerrar error */
    .btn-outline-danger:hover {
        background-color: #dc3545;
        border-color: #dc3545;
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="factura-container">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="factura-card">
                    <!-- Header -->
                    <div class="factura-header">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h2 class="mb-0">
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    Facturación CFDI 4.0
                                </h2>
                                <p class="mb-0 mt-2">Crear nueva factura</p>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="d-flex gap-2 justify-content-end">
                                    <button type="button" class="btn btn-light" onclick="limpiarFormulario()">
                                        <i class="bi bi-arrow-clockwise me-1"></i> Limpiar
                                    </button>
                                    <button type="button" class="btn btn-success" onclick="guardarFactura()">
                                        <i class="bi bi-save me-1"></i> Guardar Factura
                                    </button>
                                    <button type="button" class="btn btn-primary" onclick="imprimirFactura()">
                                        <i class="bi bi-printer me-1"></i> Imprimir
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Formulario Principal -->
                    <form id="facturaForm">
                        {% csrf_token %}
                        <!-- Fecha y Hora de Emisión -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="bi bi-calendar-event me-2"></i>
                                Fecha y Hora de Emisión
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            Fecha y Hora
                                        </label>
                                        <div class="form-control-plaintext">
                                            <i class="fas fa-calendar-alt text-muted"></i>
                                            Se establecerá automáticamente al guardar
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="serie" class="form-label">
                                            Serie <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="serie" name="serie" maxlength="10" required>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Emisor -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="bi bi-building me-2"></i>
                                Datos del Emisor
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="emisorSelect" class="form-label">
                                            Emisor <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="emisorSelect" name="emisor_id" required onchange="cargarDatosEmisor()">
                                            <option value="">Seleccionar emisor...</option>
                                            {% for emisor in emisores %}
                                            <option value="{{ emisor.codigo }}">{{ emisor.razon_social }} ({{ emisor.rfc }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="lugarExpedicion" class="form-label">
                                            Lugar de Expedición <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="lugarExpedicion" name="lugar_expedicion" maxlength="5" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row datos-emisor-ocultos" id="datosEmisor" style="display: none;">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Razón Social</label>
                                        <input type="text" class="form-control" id="emisorRazonSocial" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">RFC</label>
                                        <input type="text" class="form-control" id="emisorRfc" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Régimen Fiscal</label>
                                        <input type="text" class="form-control" id="emisorRegimenFiscal" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Entorno</label>
                                        <div id="indicadorEntorno">
                                            <!-- Se llenará dinámicamente -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row datos-emisor-ocultos" id="configuracionEmisor" style="display: none;">
                                <div class="col-md-12">
                                    <div class="alert alert-info">
                                        <h6><i class="bi bi-info-circle me-2"></i>Configuración del Emisor</h6>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <small>
                                                    <strong>PAC:</strong> <span id="emisorPac"></span><br>
                                                    <strong>Contrato:</strong> <span id="emisorContrato"></span>
                                                </small>
                                            </div>
                                            <div class="col-md-6">
                                                <small>
                                                    <strong>Usuario PAC:</strong> <span id="emisorUsuarioPac"></span><br>
                                                    <strong>Certificado:</strong> <span id="emisorCertificado"></span>
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="row datos-emisor-ocultos" id="erroresEmisor" style="display: none;">
                                <div class="col-md-12">
                                    <div class="alert alert-danger">
                                        <h6><i class="bi bi-exclamation-triangle me-2"></i>Errores de Configuración</h6>
                                        <ul id="listaErroresEmisor" class="mb-0">
                                            <!-- Se llenará dinámicamente -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Receptor -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="bi bi-person me-2"></i>
                                Datos del Receptor
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="receptorSelect" class="form-label">
                                            Cliente <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="receptorSelect" name="receptor_id" required onchange="cargarDatosCliente()">
                                            <option value="">Seleccionar cliente...</option>
                                            {% for cliente in clientes %}
                                            <option value="{{ cliente.codigo }}">{{ cliente.razon_social }} ({{ cliente.rfc }})</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="usoCfdi" class="form-label">
                                            Uso CFDI <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="usoCfdi" name="uso_cfdi" required onchange="manejarCambioUsoCFDI()">
                                            <option value="">Cargando usos CFDI...</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row" id="datosCliente" style="display: none;">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Razón Social</label>
                                        <input type="text" class="form-control" id="clienteRazonSocial" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">RFC</label>
                                        <input type="text" class="form-control" id="clienteRfc" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Código Postal</label>
                                        <input type="text" class="form-control" id="clienteCodigoPostal" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label class="form-label">Régimen Fiscal</label>
                                        <input type="text" class="form-control" id="clienteRegimenFiscal" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="exportacion" class="form-label">Exportación</label>
                                        <select class="form-select" id="exportacion" name="exportacion">
                                            <option value="01" selected>01 - No aplica</option>
                                            <option value="02">02 - Definitiva (bloqueado)</option>
                                            <option value="03">03 - Temporal</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Información Global (solo para RFC XAXX010101000) -->
                        <div class="form-section" id="informacionGlobalSection" style="display: none;">
                            <h5 class="section-title">
                                <i class="bi bi-globe me-2"></i>
                                Información Global
                                <small class="text-muted">(Requerida para RFC XAXX010101000)</small>
                            </h5>
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                Esta información es requerida cuando el receptor es "PUBLICO EN GENERAL" (RFC: XAXX010101000).
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="periodicidad" class="form-label">
                                            Periodicidad <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="periodicidad" name="periodicidad">
                                            <option value="">Seleccionar periodicidad...</option>
                                            <option value="01">01 - Mensual</option>
                                            <option value="02">02 - Bimestral</option>
                                            <option value="03">03 - Trimestral</option>
                                            <option value="04">04 - Cuatrimestral</option>
                                            <option value="05">05 - Semestral</option>
                                            <option value="06">06 - Anual</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="meses" class="form-label">
                                            Meses <span class="text-danger">*</span>
                                        </label>
                                        <select class="form-select" id="meses" name="meses">
                                            <option value="">Seleccionar mes...</option>
                                            <option value="01">01 - Enero</option>
                                            <option value="02">02 - Febrero</option>
                                            <option value="03">03 - Marzo</option>
                                            <option value="04">04 - Abril</option>
                                            <option value="05">05 - Mayo</option>
                                            <option value="06">06 - Junio</option>
                                            <option value="07">07 - Julio</option>
                                            <option value="08">08 - Agosto</option>
                                            <option value="09">09 - Septiembre</option>
                                            <option value="10">10 - Octubre</option>
                                            <option value="11">11 - Noviembre</option>
                                            <option value="12">12 - Diciembre</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="añoInformacionGlobal" class="form-label">
                                            Año <span class="text-danger">*</span>
                                        </label>
                                        <input type="number" class="form-control" id="añoInformacionGlobal" name="año_informacion_global" 
                                               min="2020" max="2030" value="2024">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Datos de Pago -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="bi bi-credit-card me-2"></i>
                                Datos de Pago
                            </h5>
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="metodoPago" class="form-label">Método de Pago</label>
                                        <select class="form-select" id="metodoPago" name="metodo_pago" onchange="cambiarFormaPago()">
                                            <option value="PUE" selected>PUE - Pago en una sola exhibición</option>
                                            <option value="PPD">PPD - Pago en parcialidades o diferido</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="moneda" class="form-label">Moneda</label>
                                        <input type="text" class="form-control" id="moneda" name="moneda" value="MXN" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="formaPago" class="form-label">Forma de Pago</label>
                                        <select class="form-select" id="formaPago" name="forma_pago">
                                            <option value="01" selected>01 - Efectivo</option>
                                            <option value="02">02 - Cheque nominativo</option>
                                            <option value="03">03 - Transferencia electrónica de fondos</option>
                                            <option value="04">04 - Tarjeta de crédito</option>
                                            <option value="05">05 - Monedero electrónico</option>
                                            <option value="06">06 - Dinero electrónico</option>
                                            <option value="08">08 - Vales de despensa</option>
                                            <option value="12">12 - Dación en pago</option>
                                            <option value="13">13 - Pago por subrogación</option>
                                            <option value="14">14 - Pago por consignación</option>
                                            <option value="15">15 - Condonación</option>
                                            <option value="17">17 - Compensación</option>
                                            <option value="23">23 - Novación</option>
                                            <option value="24">24 - Confusión</option>
                                            <option value="25">25 - Remisión de deuda</option>
                                            <option value="26">26 - Prescripción o caducidad</option>
                                            <option value="27">27 - A satisfacción del acreedor</option>
                                            <option value="28">28 - Tarjeta de débito</option>
                                            <option value="29">29 - Tarjeta de servicios</option>
                                            <option value="30">30 - Aplicación de anticipos</option>
                                            <option value="31">31 - Intermediario pagos</option>
                                            <option value="99">99 - Por definir</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="mb-3">
                                        <label for="tipoCambio" class="form-label">Tipo de Cambio</label>
                                        <input type="number" class="form-control" id="tipoCambio" name="tipo_cambio" value="1.0000" step="0.0001" min="0">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detalle de Productos -->
                        <div class="form-section">
                            <h5 class="section-title">
                                <i class="bi bi-list-ul me-2"></i>
                                Detalle de Productos/Servicios
                            </h5>
                            
                            <!-- Formulario para agregar producto -->
                            <div class="detalle-row">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="productoSelect" class="form-label">Producto/Servicio</label>
                                            <select class="form-select" id="productoSelect" onchange="cargarDatosProducto()">
                                                <option value="">Seleccionar producto...</option>
                                                {% for producto in productos %}
                                                <option value="{{ producto.codigo }}">{{ producto.descripcion }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label for="noIdentificacion" class="form-label">No. Identificación</label>
                                            <input type="text" class="form-control" id="noIdentificacion" maxlength="50">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="concepto" class="form-label">Concepto</label>
                                            <input type="text" class="form-control" id="concepto" maxlength="200">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="cantidad" class="form-label">Cantidad</label>
                                            <input type="number" class="form-control" id="cantidad" step="0.000001" min="0" max="999999999.999999" onchange="calcularImporte()">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="precio" class="form-label">Precio</label>
                                            <input type="number" class="form-control" id="precio" step="0.000001" min="0" max="999999999.999999" onchange="calcularImporte()">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="claveProdServ" class="form-label">Clave SAT</label>
                                            <input type="text" class="form-control" id="claveProdServ" maxlength="20">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="unidad" class="form-label">Unidad Medida</label>
                                            <input type="text" class="form-control" id="unidad" maxlength="20">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="objetoImpuesto" class="form-label">Objeto de Impuesto</label>
                                            <select class="form-select" id="objetoImpuesto">
                                                <option value="01">01 - No objeto del impuesto</option>
                                                <option value="02" selected>02 - Sí objeto del impuesto</option>
                                                <option value="03">03 - Sí objeto del impuesto y no obligado al desglose</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label class="form-label">Tasa de Impuesto</label>
                                            <div class="form-control-plaintext" id="tasaImpuestoDisplay">
                                                <span class="badge bg-secondary">Selecciona un producto</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label class="form-label">&nbsp;</label>
                                            <button type="button" class="btn btn-primary w-100" onclick="agregarProducto()">
                                                <i class="bi bi-plus-circle me-1"></i> Agregar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Lista de productos agregados -->
                            <div id="listaProductos">
                                <div class="empty-state">
                                    <i class="bi bi-inbox"></i>
                                    <h5>No hay productos agregados</h5>
                                    <p>Selecciona un producto y haz clic en "Agregar" para comenzar</p>
                                </div>
                            </div>
                        </div>

                        <!-- Totales -->
                        <div class="totales-section">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="total-row">
                                        <span>Subtotal:</span>
                                        <span id="subtotal">$0.00</span>
                                    </div>
                                    <div class="total-row">
                                        <span>Impuesto (16%):</span>
                                        <span id="impuesto">$0.00</span>
                                    </div>
                                    <div class="total-row">
                                        <span><strong>Total:</strong></span>
                                        <span id="total"><strong>$0.00</strong></span>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-warning btn-lg" onclick="timbrarFactura()" id="btnTimbrar">
                                            <i class="bi bi-stamp me-2"></i> Timbrar CFDI
                                        </button>
                                        <button type="button" class="btn btn-info" onclick="validarFactura()" id="btnValidar">
                                            <i class="bi bi-check-circle me-2"></i> Validar CFDI
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="imprimirFactura()">
                                            <i class="bi bi-printer me-2"></i> Imprimir
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let productosAgregados = [];
let contadorProductos = 0;

// Inicializar fecha actual
document.addEventListener('DOMContentLoaded', function() {
    // La fecha se establecerá automáticamente en el backend
    cargarUsosCFDI();
});

// Cargar catálogo de usos CFDI desde el SAT
function cargarUsosCFDI() {
    fetch('/ajax/catalogos/usos-cfdi/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('usoCfdi');
            select.innerHTML = '<option value="">Seleccionar uso CFDI...</option>';
            
            if (data.success) {
                data.usos_cfdi.forEach(uso => {
                    const option = document.createElement('option');
                    option.value = uso.codigo;
                    option.textContent = uso.texto_completo;
                    select.appendChild(option);
                });
            } else {
                console.error('Error cargando usos CFDI:', data.error);
                // Fallback a opciones básicas
                const opcionesBasicas = [
                    {codigo: 'G01', descripcion: 'Adquisición de mercancías'},
                    {codigo: 'G02', descripcion: 'Devoluciones, descuentos o bonificaciones'},
                    {codigo: 'G03', descripcion: 'Gastos en general'},
                    {codigo: 'P01', descripcion: 'Por definir'}
                ];
                
                opcionesBasicas.forEach(uso => {
                    const option = document.createElement('option');
                    option.value = uso.codigo;
                    option.textContent = `${uso.codigo} - ${uso.descripcion}`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error cargando usos CFDI:', error);
            // Fallback a opciones básicas
            const select = document.getElementById('usoCfdi');
            select.innerHTML = '<option value="">Seleccionar uso CFDI...</option>';
            const opcionesBasicas = [
                {codigo: 'G01', descripcion: 'Adquisición de mercancías'},
                {codigo: 'G02', descripcion: 'Devoluciones, descuentos o bonificaciones'},
                {codigo: 'G03', descripcion: 'Gastos en general'},
                {codigo: 'P01', descripcion: 'Por definir'}
            ];
            
            opcionesBasicas.forEach(uso => {
                const option = document.createElement('option');
                option.value = uso.codigo;
                option.textContent = `${uso.codigo} - ${uso.descripcion}`;
                select.appendChild(option);
            });
        });
}

// Cargar datos del emisor
function cargarDatosEmisor() {
    const emisorId = document.getElementById('emisorSelect').value;
    if (!emisorId) {
        // No cambiar display de elementos ocultos, solo deshabilitar botón
        document.getElementById('btnTimbrar').disabled = true;
        
        // Limpiar error de timbrado al cambiar emisor
        return;
    }

    fetch(`/ajax/emisores/${emisorId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('Datos del emisor recibidos:', data.emisor);
                
                // Cargar solo campos visibles
                document.getElementById('serie').value = data.emisor.serie || 'A';
                
                // Llenar lugar de expedición
                const lugarExpedicion = document.getElementById('lugarExpedicion');
                console.log('Campo lugarExpedicion encontrado:', lugarExpedicion);
                console.log('Valor a asignar:', data.emisor.codigo_postal);
                if (lugarExpedicion) {
                    lugarExpedicion.value = data.emisor.codigo_postal;
                    console.log('Valor asignado al campo:', lugarExpedicion.value);
                } else {
                    console.error('Campo lugarExpedicion no encontrado');
                }
                
                // Llenar campos ocultos (para funcionalidad interna)
                try {
                    document.getElementById('emisorRazonSocial').value = data.emisor.razon_social;
                    document.getElementById('emisorRfc').value = data.emisor.rfc;
                    document.getElementById('emisorRegimenFiscal').value = data.emisor.regimen_fiscal_display;
                    document.getElementById('emisorCodigoPostal').value = data.emisor.codigo_postal;
                } catch (e) {
                    console.log('Algunos campos ocultos no están disponibles:', e.message);
                }
                
                // Mostrar indicador de entorno
                mostrarIndicadorEntorno(data.emisor.timbrado_prueba);
                
                // Mostrar configuración del emisor
                mostrarConfiguracionEmisor(data.emisor);
                
                // Validar configuración
                validarConfiguracionEmisor(emisorId);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion('Error al cargar datos del emisor', 'error');
        });
}

// Mostrar indicador de entorno
function mostrarIndicadorEntorno(esPrueba) {
    const indicador = document.getElementById('indicadorEntorno');
    
    if (esPrueba) {
        indicador.innerHTML = `
            <span class="badge bg-warning text-dark">
                <i class="bi bi-exclamation-triangle me-1"></i>
                PRUEBAS
            </span>
            <small class="text-muted d-block">Facturas de prueba</small>
        `;
    } else {
        indicador.innerHTML = `
            <span class="badge bg-success">
                <i class="bi bi-check-circle me-1"></i>
                PRODUCCIÓN
            </span>
            <small class="text-muted d-block">Facturas válidas</small>
        `;
    }
}

// Mostrar configuración del emisor
function mostrarConfiguracionEmisor(emisor) {
    document.getElementById('emisorPac').textContent = emisor.nombre_pac || 'No configurado';
    document.getElementById('emisorContrato').textContent = emisor.contrato || 'No configurado';
    document.getElementById('emisorUsuarioPac').textContent = emisor.usuario_pac || 'No configurado';
    document.getElementById('emisorCertificado').textContent = emisor.archivo_certificado ? 'Configurado' : 'No configurado';
    
    // No mostrar el elemento ya que está oculto visualmente
}

// Validar configuración del emisor
function validarConfiguracionEmisor(emisorId) {
    fetch(`/ajax/emisores/${emisorId}/validar/`)
        .then(response => response.json())
        .then(data => {
            if (data.valido) {
                // No cambiar display de elementos ocultos
                document.getElementById('btnTimbrar').disabled = false;
                
                if (data.advertencias && data.advertencias.length > 0) {
                    mostrarNotificacion(data.advertencias.join(', '), 'warning');
                }
            } else {
                // Mostrar errores
                const listaErrores = document.getElementById('listaErroresEmisor');
                listaErrores.innerHTML = '';
                data.errores.forEach(error => {
                    const li = document.createElement('li');
                    li.textContent = error;
                    listaErrores.appendChild(li);
                });
                
                // No mostrar el elemento ya que está oculto visualmente
                document.getElementById('btnTimbrar').disabled = true;
            }
        })
        .catch(error => {
            console.error('Error validando emisor:', error);
            document.getElementById('btnTimbrar').disabled = true;
        });
}

// Manejar cambio de UsoCFDI
function manejarCambioUsoCFDI() {
    const usoCfdi = document.getElementById('usoCfdi').value;
    const clienteRfc = document.getElementById('clienteRfc').value;
    
    // Si se selecciona S01 y el receptor es PUBLICO EN GENERAL, mostrar información global
    if (usoCfdi === 'S01' && clienteRfc === 'XAXX010101000') {
        document.getElementById('informacionGlobalSection').style.display = 'block';
        // Establecer valores por defecto si no están establecidos
        if (!document.getElementById('periodicidad').value) {
            document.getElementById('periodicidad').value = '01';
        }
        if (!document.getElementById('meses').value) {
            const mesActual = new Date().getMonth() + 1;
            document.getElementById('meses').value = mesActual.toString().padStart(2, '0');
        }
        if (!document.getElementById('añoInformacionGlobal').value) {
            document.getElementById('añoInformacionGlobal').value = new Date().getFullYear();
        }
    } else if (usoCfdi !== 'S01' && clienteRfc === 'XAXX010101000') {
        // Si se cambia a otro UsoCFDI que no sea S01, ocultar información global
        document.getElementById('informacionGlobalSection').style.display = 'none';
    }
}

// Cargar datos del cliente
function cargarDatosCliente() {
    const clienteId = document.getElementById('receptorSelect').value;
    if (!clienteId) {
        document.getElementById('datosCliente').style.display = 'none';
        document.getElementById('informacionGlobalSection').style.display = 'none';
        return;
    }

    fetch(`/ajax/clientes/${clienteId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('clienteRazonSocial').value = data.cliente.razon_social;
                document.getElementById('clienteRfc').value = data.cliente.rfc;
                document.getElementById('clienteCodigoPostal').value = data.cliente.codigo_postal;
                document.getElementById('clienteRegimenFiscal').value = data.cliente.regimen_fiscal_display;
                document.getElementById('datosCliente').style.display = 'block';
                
                // Mostrar/ocultar sección de Información Global para RFC XAXX010101000
                if (data.cliente.rfc === 'XAXX010101000') {
                    document.getElementById('informacionGlobalSection').style.display = 'block';
                    // Establecer valores por defecto
                    document.getElementById('periodicidad').value = '01'; // Mensual
                    const mesActual = new Date().getMonth() + 1;
                    document.getElementById('meses').value = mesActual.toString().padStart(2, '0');
                    document.getElementById('añoInformacionGlobal').value = new Date().getFullYear();
                    
                    // Establecer UsoCFDI automáticamente a S01
                    document.getElementById('usoCfdi').value = 'S01';
                } else {
                    document.getElementById('informacionGlobalSection').style.display = 'none';
                    // Limpiar campos
                    document.getElementById('periodicidad').value = '';
                    document.getElementById('meses').value = '';
                    document.getElementById('añoInformacionGlobal').value = '';
                    
                    // Limpiar UsoCFDI si no es RFC genérico
                    document.getElementById('usoCfdi').value = '';
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion('Error al cargar datos del cliente', 'error');
        });
}

// Cargar datos del producto
function cargarDatosProducto() {
    const productoId = document.getElementById('productoSelect').value;
    console.log('Producto seleccionado:', productoId);
    
    if (!productoId) {
        limpiarCamposProducto();
        return;
    }

    console.log('Haciendo petición a:', `/ajax/productos/${productoId}/`);
    
    fetch(`/ajax/productos/${productoId}/`)
        .then(response => {
            console.log('Respuesta recibida:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Datos recibidos:', data);
            if (data.success) {
                // Mostrar el código del producto en No Identificación
                console.log('Código del producto:', data.producto.codigo);
                console.log('Tasa de impuesto:', data.producto.tasa_impuesto);
                document.getElementById('noIdentificacion').value = data.producto.codigo;
                document.getElementById('concepto').value = data.producto.descripcion;
                // El precio se ingresa manualmente, no se carga del catálogo
                document.getElementById('claveProdServ').value = data.producto.clave_prod_serv;
                document.getElementById('unidad').value = data.producto.unidad_medida;
                
                // Guardar la tasa de impuesto para usar en cálculos
                window.tasaImpuestoProducto = data.producto.tasa_impuesto;
                
                // Mostrar la tasa de impuesto
                actualizarTasaImpuestoDisplay(data.producto.tasa_impuesto, data.producto.impuesto);
                
                // No llamar calcularImporte() porque el precio está vacío
            } else {
                console.error('Error en respuesta:', data.error);
                mostrarNotificacion(data.error || 'Error al cargar datos del producto', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            mostrarNotificacion('Error al cargar datos del producto', 'error');
        });
}

// Limpiar campos del producto
function limpiarCamposProducto() {
    document.getElementById('noIdentificacion').value = '';
    document.getElementById('concepto').value = '';
    document.getElementById('cantidad').value = '';
    // No limpiar precio, se ingresa manualmente
    document.getElementById('claveProdServ').value = '';
    document.getElementById('unidad').value = '';
    
    // Limpiar tasa de impuesto
    window.tasaImpuestoProducto = undefined;
    actualizarTasaImpuestoDisplay(0, '');
}

// Actualizar visualización de tasa de impuesto
function actualizarTasaImpuestoDisplay(tasa, tipoImpuesto) {
    const display = document.getElementById('tasaImpuestoDisplay');
    
    if (tasa === 0) {
        if (tipoImpuesto === 'IVA_0') {
            display.innerHTML = '<span class="badge bg-info">IVA Tasa 0%</span>';
        } else if (tipoImpuesto === 'IVA_EXENTO') {
            display.innerHTML = '<span class="badge bg-warning">IVA Exento</span>';
        } else {
            display.innerHTML = '<span class="badge bg-secondary">Selecciona un producto</span>';
        }
    } else {
        display.innerHTML = `<span class="badge bg-success">IVA ${(tasa * 100).toFixed(0)}%</span>`;
    }
}

// Calcular importe
function calcularImporte() {
    const cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
    const precio = parseFloat(document.getElementById('precio').value) || 0;
    const importe = cantidad * precio;
    
    // Calcular impuesto si hay tasa definida
    let impuesto = 0;
    if (window.tasaImpuestoProducto !== undefined) {
        impuesto = importe * window.tasaImpuestoProducto;
    }
    
    // Mostrar cálculo en consola para debugging
    console.log(`Cálculo: ${cantidad} × ${precio} = ${importe}, Impuesto: ${impuesto.toFixed(2)}`);
}

// Cambiar forma de pago según método de pago
function cambiarFormaPago() {
    const metodoPago = document.getElementById('metodoPago').value;
    const formaPago = document.getElementById('formaPago');
    
    if (metodoPago === 'PPD') {
        // Si es PPD (Pago en parcialidades), cambiar a 99 - Por definir
        formaPago.value = '99';
    } else if (metodoPago === 'PUE') {
        // Si es PUE (Pago en una sola exhibición), cambiar a 01 - Efectivo por defecto
        // pero permitir que el usuario lo cambie después
        formaPago.value = '01';
    }
}

// Agregar producto a la lista
function agregarProducto() {
    const productoId = document.getElementById('productoSelect').value;
    const noIdentificacion = document.getElementById('noIdentificacion').value.trim();
    const concepto = document.getElementById('concepto').value.trim();
    const cantidad = parseFloat(document.getElementById('cantidad').value) || 0;
    const precio = parseFloat(document.getElementById('precio').value) || 0;
    const claveProdServ = document.getElementById('claveProdServ').value.trim();
    const unidad = document.getElementById('unidad').value.trim();
    const objetoImpuesto = document.getElementById('objetoImpuesto').value;

    // Validaciones
    if (!productoId) {
        mostrarNotificacion('Selecciona un producto', 'warning');
        return;
    }
    if (!concepto) {
        mostrarNotificacion('El concepto es requerido', 'warning');
        return;
    }
    if (cantidad <= 0) {
        mostrarNotificacion('La cantidad debe ser mayor a 0', 'warning');
        return;
    }
    if (cantidad > 999999999.999999) { // 9 dígitos antes del punto decimal
        mostrarNotificacion('La cantidad no puede exceder 999,999,999.999999', 'warning');
        return;
    }
    if (precio <= 0) {
        mostrarNotificacion('El precio debe ser mayor a 0', 'warning');
        return;
    }
    if (precio > 999999999.999999) { // 9 dígitos antes del punto decimal
        mostrarNotificacion('El precio no puede exceder 999,999,999.999999', 'warning');
        return;
    }

    const importe = cantidad * precio;
    
    // Calcular impuesto según la tasa del producto y objeto de impuesto
    let impuesto = 0;
    if (objetoImpuesto === '02' && window.tasaImpuestoProducto !== undefined) {
        impuesto = importe * window.tasaImpuestoProducto;
    }

    const producto = {
        id: ++contadorProductos,
        producto_id: productoId,
        no_identificacion: noIdentificacion,
        concepto: concepto,
        cantidad: cantidad,
        precio: precio,
        clave_prod_serv: claveProdServ,
        unidad: unidad,
        objeto_impuesto: objetoImpuesto,
        importe: importe,
        impuesto: impuesto
    };

    productosAgregados.push(producto);
    actualizarListaProductos();
    actualizarTotales();
    limpiarCamposProducto();
    document.getElementById('productoSelect').value = '';
}

// Actualizar lista de productos
function actualizarListaProductos() {
    const lista = document.getElementById('listaProductos');
    
    if (productosAgregados.length === 0) {
        lista.innerHTML = `
            <div class="empty-state">
                <i class="bi bi-inbox"></i>
                <h5>No hay productos agregados</h5>
                <p>Selecciona un producto y haz clic en "Agregar" para comenzar</p>
            </div>
        `;
        return;
    }

    let html = '';
    productosAgregados.forEach(producto => {
        html += `
            <div class="detalle-item">
                <button type="button" class="btn-remove-item" onclick="eliminarProducto(${producto.id})">
                    <i class="bi bi-x"></i>
                </button>
                <div class="row">
                    <div class="col-md-3">
                        <strong>Concepto:</strong> ${producto.concepto}
                    </div>
                    <div class="col-md-2">
                        <strong>Cantidad:</strong> ${producto.cantidad}
                    </div>
                    <div class="col-md-2">
                        <strong>Precio:</strong> $${producto.precio.toFixed(2)}
                    </div>
                    <div class="col-md-2">
                        <strong>Importe:</strong> $${producto.importe.toFixed(2)}
                    </div>
                    <div class="col-md-2">
                        <strong>Impuesto:</strong> $${producto.impuesto.toFixed(2)}
                    </div>
                    <div class="col-md-1">
                        <strong>Total:</strong> $${(producto.importe + producto.impuesto).toFixed(2)}
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-2">
                        <small><strong>No. Identificación:</strong> ${producto.no_identificacion}</small>
                    </div>
                    <div class="col-md-2">
                        <small><strong>Clave SAT:</strong> ${producto.clave_prod_serv}</small>
                    </div>
                    <div class="col-md-2">
                        <small><strong>Unidad Medida:</strong> ${producto.unidad}</small>
                    </div>
                    <div class="col-md-2">
                        <small><strong>Objeto Impuesto:</strong> ${producto.objeto_impuesto}</small>
                    </div>
                </div>
            </div>
        `;
    });

    lista.innerHTML = html;
}

// Eliminar producto de la lista
function eliminarProducto(id) {
    productosAgregados = productosAgregados.filter(p => p.id !== id);
    actualizarListaProductos();
    actualizarTotales();
}

// Actualizar totales
function actualizarTotales() {
    let subtotal = 0;
    let impuesto = 0;

    productosAgregados.forEach(producto => {
        subtotal += producto.importe;
        impuesto += producto.impuesto;
    });

    const total = subtotal + impuesto;

    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('impuesto').textContent = `$${impuesto.toFixed(2)}`;
    document.getElementById('total').innerHTML = `<strong>$${total.toFixed(2)}</strong>`;
}

// Validar CFDI
function validarFactura() {
    if (!validarFormulario()) {
        return;
    }
    
    mostrarNotificacion('Validando CFDI...', 'info');
    
    // Preparar datos para validación
    const datosValidacion = prepararDatosFactura();
    
    fetch('/ajax/facturas/validar/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(datosValidacion)
    })
    .then(response => response.json())
    .then(data => {
        if (data.valido) {
            mostrarNotificacion('CFDI válido - Listo para timbrar', 'success');
            document.getElementById('btnTimbrar').disabled = false;
        } else {
            mostrarNotificacion('CFDI inválido: ' + data.errores.join(', '), 'error');
            document.getElementById('btnTimbrar').disabled = true;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion('Error al validar CFDI', 'error');
    });
}

// Timbrar CFDI - Función principal

// Preparar datos de la factura para validación/timbrado
function prepararDatosFactura() {
    const emisorId = document.getElementById('emisorSelect').value;
    const receptorId = document.getElementById('receptorSelect').value;
    const serie = document.getElementById('serie').value;
    
    if (!emisorId || !receptorId || !serie) {
        throw new Error('Faltan datos obligatorios');
    }
    
    return {
        emisor_id: emisorId,
        receptor_id: receptorId,
        serie: serie,
        fecha_emision: new Date().toISOString(), // Fecha actual
        lugar_expedicion: document.getElementById('lugarExpedicion').value,
        uso_cfdi: document.getElementById('usoCfdi').value,
        exportacion: document.getElementById('exportacion').value,
        metodo_pago: document.getElementById('metodoPago').value,
        moneda: document.getElementById('moneda').value,
        forma_pago: document.getElementById('formaPago').value,
        tipo_cambio: document.getElementById('tipoCambio').value,
        detalles: productosAgregados
    };
}

// Limpiar formulario
function limpiarFormulario() {
    document.getElementById('facturaForm').reset();
    // La fecha se establecerá automáticamente en el backend
    document.getElementById('moneda').value = 'MXN';
    document.getElementById('tipoCambio').value = '1.0000';
    document.getElementById('metodoPago').value = 'PUE';
    document.getElementById('formaPago').value = '01'; // Efectivo por defecto
    document.getElementById('exportacion').value = '01';
    document.getElementById('objetoImpuesto').value = '02';
    
    productosAgregados = [];
    contadorProductos = 0;
    actualizarListaProductos();
    actualizarTotales();
    
    // No cambiar display de elementos ocultos
    document.getElementById('datosCliente').style.display = 'none';
    
    // Limpiar error de timbrado
}

// Imprimir factura
function imprimirFactura() {
    if (productosAgregados.length === 0) {
        mostrarNotificacion('No hay productos para imprimir', 'warning');
        return;
    }
    
    // Aquí implementarías la lógica de impresión
    mostrarNotificacion('Funcionalidad de impresión en desarrollo', 'info');
}

// Función para obtener cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Validar formulario
function validarFormulario() {
    // Validar emisor
    const emisorSelect = document.getElementById('emisorSelect');
    if (!emisorSelect.value) {
        mostrarNotificacion('Debe seleccionar un emisor', 'error');
        emisorSelect.focus();
        return false;
    }
    
    // Validar receptor
    const receptorSelect = document.getElementById('receptorSelect');
    if (!receptorSelect.value) {
        mostrarNotificacion('Debe seleccionar un receptor', 'error');
        receptorSelect.focus();
        return false;
    }
    
    // La fecha se validará automáticamente en el backend
    
    // Validar lugar de expedición
    const lugarExpedicion = document.getElementById('lugarExpedicion');
    if (!lugarExpedicion.value) {
        mostrarNotificacion('Debe ingresar el lugar de expedición', 'error');
        lugarExpedicion.focus();
        return false;
    }
    
    // Validar que el lugar de expedición sea un código postal válido
    const codigoPostalRegex = /^\d{5}$/;
    if (!codigoPostalRegex.test(lugarExpedicion.value)) {
        mostrarNotificacion('El lugar de expedición debe ser un código postal de 5 dígitos', 'error');
        lugarExpedicion.focus();
        return false;
    }
    
    // Validar que se hayan agregado productos a la factura
    if (productosAgregados.length === 0) {
        mostrarNotificacion('Debe agregar al menos un producto a la factura', 'error');
        return false;
    }
    
    return true;
}

// Función principal para timbrar CFDI (guarda y timbra en un solo proceso)
function timbrarFactura() {
    console.log('Iniciando función timbrarFactura');
    
    // Validar formulario
    if (!validarFormulario()) {
        console.log('Validación de formulario falló');
        return;
    }
    
    // Obtener el botón y mostrar estado de carga
    const boton = document.getElementById('btnTimbrar');
    const textoOriginal = boton.innerHTML;
    boton.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> Procesando...';
    boton.disabled = true;
    
    // Mostrar notificación de inicio
    mostrarNotificacion('Iniciando proceso de timbrado...', 'info');
    
    // Limpiar error anterior
    
    // Preparar datos de la factura
    const formData = new FormData();
    formData.append('serie', document.getElementById('serie').value);
    formData.append('emisor_id', document.getElementById('emisorSelect').value);
    formData.append('fecha_emision', new Date().toISOString());
    formData.append('lugar_expedicion', document.getElementById('lugarExpedicion').value);
    formData.append('receptor_id', document.getElementById('receptorSelect').value);
    formData.append('uso_cfdi', document.getElementById('usoCfdi').value);
    formData.append('exportacion', document.getElementById('exportacion').value);
    formData.append('metodo_pago', document.getElementById('metodoPago').value);
    formData.append('moneda', document.getElementById('moneda').value);
    formData.append('forma_pago', document.getElementById('formaPago').value);
    formData.append('tipo_cambio', document.getElementById('tipoCambio').value);
    formData.append('detalles', JSON.stringify(productosAgregados));
    
    // Información Global (solo si está visible)
    if (document.getElementById('informacionGlobalSection').style.display !== 'none') {
        formData.append('periodicidad', document.getElementById('periodicidad').value);
        formData.append('meses', document.getElementById('meses').value);
        formData.append('año_informacion_global', document.getElementById('añoInformacionGlobal').value);
    }
    
    // Obtener token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                     document.querySelector('meta[name=csrf-token]')?.getAttribute('content') ||
                     getCookie('csrftoken');
    
    if (!csrfToken) {
        mostrarNotificacion('Error: No se pudo obtener el token CSRF', 'error');
        boton.innerHTML = textoOriginal;
        boton.disabled = false;
        return;
    }
    
    // Paso 1: Guardar la factura
    mostrarNotificacion('Guardando factura...', 'info');
    
    fetch('/ajax/facturas/guardar/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarNotificacion('Factura guardada, iniciando timbrado...', 'success');
            
            // Paso 2: Timbrar la factura
            return fetch(`/ajax/facturas/timbrar/${data.factura_id}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/json',
                }
            });
        } else {
            throw new Error(data.error || 'Error al guardar la factura');
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarNotificacion(`¡CFDI timbrado exitosamente! Serie: ${data.serie_folio}`, 'success');
            
            // Limpiar formulario
            limpiarFormulario();
            
            // Redireccionar al listado después de 3 segundos
            setTimeout(() => {
                window.location.href = '/listado-facturas/';
            }, 3000);
               } else {
                   console.log('Error en timbrado:', data);
                   
                   // Mostrar error específico del timbrado
                   let mensajeError = data.error || 'Error desconocido al timbrar';
                   let codigoError = data.codigo_error || 'UNKNOWN_ERROR';
                   let detalles = data.detalles || [];
                   
                   console.log('Mostrando error:', { mensajeError, codigoError, detalles });
                   
                   // Mostrar error en el campo del pie de página
                   mostrarErrorTimbrado(mensajeError, codigoError, detalles);
                   
                   // También mostrar en consola para debugging
                   console.error('Error detallado del timbrado:', {
                       codigo: codigoError,
                       error: mensajeError,
                       detalles: detalles
                   });
                   
                   // NO limpiar formulario ni redireccionar automáticamente
                   // Permitir al usuario revisar el error y corregir
               }
    })
    .catch(error => {
        console.error('Error:', error);
        mostrarNotificacion(`Error en el proceso: ${error.message}`, 'error');
    })
    .finally(() => {
        // Restaurar botón
        boton.innerHTML = textoOriginal;
        boton.disabled = false;
    });
}


// Mostrar notificación
function mostrarNotificacion(mensaje, tipo = 'info', tiempo = null) {
    // Limpiar notificaciones existentes para evitar que se encimen
    const notificacionesExistentes = document.querySelectorAll('.alert.position-fixed');
    notificacionesExistentes.forEach(notif => notif.remove());
    
    // Crear elemento de notificación
    const notificacion = document.createElement('div');
    notificacion.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    
    // Ajustar tamaño según el tipo de mensaje
    if (mensaje.includes('\n') || mensaje.length > 100) {
        // Mensaje largo o con saltos de línea
        notificacion.style.cssText = 'bottom: 20px; left: 20px; z-index: 9999; min-width: 500px; max-width: 700px; max-height: 400px; overflow-y: auto; white-space: pre-line;';
    } else {
        // Mensaje corto
        notificacion.style.cssText = 'bottom: 20px; left: 20px; z-index: 9999; min-width: 300px; max-width: 400px;';
    }
    
    notificacion.innerHTML = `
        <div style="white-space: pre-line;">${mensaje}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    
    // Agregar al DOM
    document.body.appendChild(notificacion);
    
    // Auto-remover después del tiempo especificado o por defecto
    const tiempoFinal = tiempo || (tipo === 'error' ? 5000 : 3000);
    setTimeout(() => {
        if (notificacion.parentNode) {
            notificacion.remove();
        }
    }, tiempoFinal);
}

// Mostrar error de timbrado solo con notificaciones
function mostrarErrorTimbrado(error, codigoError = '', detalles = []) {
    console.log('mostrarErrorTimbrado llamada con:', { error, codigoError, detalles });
    
    // Construir mensaje de error detallado
    let mensajeError = `Error al timbrar: ${error}`;
    
    if (codigoError) {
        mensajeError += ` (Código: ${codigoError})`;
    }
    
    if (detalles && detalles.length > 0) {
        mensajeError += ` - ${detalles.join(', ')}`;
    }
    
    console.log('Mensaje de error construido:', mensajeError);
    
    // Mostrar notificación global (showNotification de main.js)
    if (typeof window.showNotification === 'function') {
        window.showNotification(mensajeError, 'danger', false);
    } else {
        // Fallback a notificación local si no está disponible
        mostrarNotificacion(mensajeError, 'error', 5000);
    }
}

</script>
{% endblock %}
